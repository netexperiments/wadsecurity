{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"]},"docs":[{"location":"","title":"Home","text":"<p>The aim of this laboratory work is to study the Windows Active Directory system and its vulnerabilities.</p>"},{"location":"#labs","title":"Labs","text":"<ul> <li>Intra-domain attacks</li> <li>Inter-domain attacks</li> </ul>"},{"location":"#contributors","title":"Contributors","text":"<ul> <li>Bernardo Salva\u00e7\u00e3o, Instituto Superior T\u00e9cnico, Universidade de Lisboa</li> <li>Rui Valadas, Instituto Superior T\u00e9cnico, Universidade de Lisboa</li> <li>Filipe Bernardo, Devoteam</li> <li>Bruno Morrison, Devoteam</li> </ul>"},{"location":"labs/dc-configuration/","title":"Domain Controller configuration","text":"<p>The installation and configuration of the DC involves several steps:</p> <ol> <li>Configure the IP addresses and domain name</li> <li>Rename the server</li> <li>Adjust the clock</li> <li>Install the Active Directory</li> <li>Configure DNS</li> <li>Configure users</li> <li>Install and configure IIS</li> <li>Install and configure DHCP</li> <li>Disable SMB signing</li> </ol>"},{"location":"labs/dc-configuration/#configure-the-ip-addresses-and-domain-name","title":"Configure the IP addresses and domain name","text":"<p>Before configuring the IP addresses, you must learn what is the subnet where the NAT cloud is operating. One way of learning is to start the attacker and check the IP address, subnet mask, and gateway it gets from the NAT DHCP server (e.g., using <code>ip add</code> and <code>ip route</code>). In our case, the subnet is <code>198.168.122.0/24</code>, and the gateway is <code>198.168.122.1</code>. Then, the following actions must be performed:</p> <ol> <li>Under <code>Server Manager \u2192 Local Server \u2192 Properties</code> click on the <code>Ethernet</code> link, then on the <code>Ethernet</code> adapter, and finally click <code>Properties \u2192 IPv4</code>.</li> <li>At this window enter <code>IP address</code> as 192.168.122.10, <code>subnet mask</code> as 255.255.255.0, <code>default gateway</code> as 192.168.122.1, and <code>DNS servers</code> as 192.168.122.10 and 8.8.8.8.</li> <li>Click <code>Advanced</code>, select the <code>DNS</code> tab, and in the box <code>DNS suffix for this connection</code> write polaris.local.</li> <li>Apply all the changes and return to the <code>Server Manager</code> window.</li> </ol>"},{"location":"labs/dc-configuration/#rename-the-server","title":"Rename the server","text":"<ol> <li>Change the name of the server to DC1. This can be done in the <code>Control Panel</code> under <code>System</code>. Restart the computer to apply the changes.</li> </ol>"},{"location":"labs/dc-configuration/#adjust-the-clock","title":"Adjust the clock","text":"<ol> <li>Make sure that the time zone, the date, and the time are correctly set. The time zone must be set to UTC. The date and time must be close to the attacker\u2019s one. The easiest way is to make the adjustments in the Control Panel.</li> </ol>"},{"location":"labs/dc-configuration/#install-the-active-directory","title":"Install the Active Directory","text":"<ol> <li>In the <code>Server Manager</code>, click <code>Manage \u2192 Add Roles and features</code>, then click <code>Next</code> until reaching the <code>Server Roles</code> tab.</li> <li>Check the <code>Active Directory Domain Services</code> box, click <code>Add features</code> and click <code>Next</code> until the <code>Confirmation</code> tab appears. At this tab click <code>Install</code>.</li> <li>After the installation, click <code>Promote this server to a domain controller</code>.</li> <li>Select <code>Add a new forest</code> and write polaris.local in the <code>Root Domain name</code> box. Then click <code>Next</code>.</li> <li>Enter the password for the DSRM administrator account. Then click <code>Next</code> until the <code>Prerequisites</code> tab appears and click on <code>Install</code>.</li> </ol>"},{"location":"labs/dc-configuration/#configure-dns","title":"Configure DNS","text":"<ol> <li>Go back to the IP address configuration window and reconfigure the <code>DNS servers</code> as 192.168.122.10 and 8.8.8.8. Apply the changes and return to the <code>Server Manager</code> window.</li> <li>Click <code>Tools \u2192 DNS \u2192 DC1</code>.</li> <li>Right-click on <code>Reverse Lookup Zones</code>, then click <code>New Zone \u2192 Next \u2192 Primary zone \u2192 Next</code> and select <code>To all DNS servers running... in this forest: polaris.local</code>.</li> <li>Click <code>Next \u2192 IPv4 Reverse Lookup Zone \u2192 Next</code>. In <code>NetworkID</code> box enter 192.168.122. Then click <code>Next \u2192 Next \u2192 Finish</code>. A new entry should have appeared in the <code>Reverse Lookup Zones</code> tab.</li> </ol>"},{"location":"labs/dc-configuration/#configure-users","title":"Configure users","text":"<p>To configure one user, in the <code>Server Manager</code> click <code>Tools \u2192 Active Directory Users and Computers \u2192 Action \u2192 New \u2192 User</code>. Then, enter the user credentials. Uncheck the option <code>User must change password at next logon</code>. You must create four users with different characteristics, as indicated in the next table.</p> User logon name Password Domain Description darlene.alderson M00npie polaris.local Account with an associated SPN leslie.romero RGFyayBBcm15 polaris.local Password in description leon Password123 polaris.local Weak password angela.moss Jogging1988 polaris.local Kerberos pre-authentication disabled admin Passw0rd polaris.local Administrator account <ol> <li>User angela.moss must be configured with the pre-authentication disabled. To do that access the user <code>Properties</code> (e.g., double-click over the username in the <code>Active Directory Users and Computers</code> window) and in the <code>Account tab \u2192 Account options</code> box check <code>Do not require Kerberos preauthentication</code>.</li> <li>User leslie.romero must be configured with a password in the description. In the <code>General tab \u2192 Description</code> box write <code>DELETE THIS LATER! Password: RGFyayBBcm15</code>.</li> <li>The account of darlene.alderson must have an associated SPN. To perform this configuration, click <code>Tools \u2192 ADSI Edit \u2192 Action \u2192 Connect</code>. Then in <code>DC=polaris,DC=local \u2192 CN=Users</code> search for <code>CN=darlene alderson</code>. Right-click on this CN, select <code>Properties</code> and in the <code>Attribute Editor</code> tab search for <code>servicePrincipalName</code>. Select the attribute, click <code>Edit</code> and insert <code>http/polaris.local:80</code> in the <code>Value to add</code> box.</li> </ol>"},{"location":"labs/dc-configuration/#install-and-configure-iis","title":"Install and configure IIS","text":"<ol> <li>In the <code>Server Manager</code>, click <code>Manage \u2192 Add Roles and features</code>, then click <code>Next</code> until reaching the <code>Server Roles</code> tab.</li> <li>Check the <code>Web Server(IIS)</code> box, click <code>Add features</code> and click <code>Next</code> until reaching the <code>Role Services</code> tab.</li> <li>Check the <code>Windows Authentication</code> box which is one of the <code>Security</code> options. Then click <code>Next</code> until the <code>Confirmation</code> tab appears. At this tab click <code>Install</code>.</li> <li>Click <code>Tools \u2192 Internet Information Services (IIS) Manager</code>, on the left window open <code>DC1 (Polaris\\Administrator)</code> and then <code>Sites</code>, click above <code>Default Web Site</code>, on the center window double-click over Authentication. Here disable Anonymous Authentication and enable Windows Authentication.</li> <li>On the right window open <code>Providers</code> and make sure that <code>Negotiate</code> is above <code>NTLM</code>. This ensures that Kerberos is selected first as the authentication method, and NTLM is used if Kerberos fails.</li> <li>On the left window select <code>Application Pools</code>, on the center window click over <code>DefaultAppPool</code>, and on the right window open <code>Advanced Settings</code>. Confirm that the <code>Identity</code> attribute is set to <code>ApplicationPoolIdentity</code>.</li> <li>On the left window select <code>Default Web Site</code>, and on the center window double-click over <code>Configuration Editor</code>. Then, in the dropdown menu select <code>system.webServer \u2192 security \u2192 authentication \u2192 windowsAuthentication</code>. Here, set <code>useAppPoolCredentials</code> to <code>False</code> and <code>useKernelMode</code> to <code>True</code>.</li> </ol>"},{"location":"labs/dc-configuration/#install-and-configure-dhcp","title":"Install and configure DHCP","text":"<ol> <li>In the <code>Server Manager</code>, click <code>Manage \u2192 Add Roles and features</code>, then click <code>Next</code> until reaching the <code>Server Roles</code> tab.</li> <li>Check the <code>DHCP Server</code> box, click <code>Add features</code> and click <code>Next</code> until the <code>Confirmation</code> tab appears. At this tab click <code>Install</code>. This completes the installation of the DHCP server.</li> <li>To configure the DHCP server click <code>Tools \u2192 DHCP</code>, on the left window open <code>dc1.polaris.local</code>, right-click <code>IPv4</code>, and select <code>New Scope</code>. In the <code>Scope Name</code> window give a name to the scope, in the <code>IP Address Range</code> window configure the <code>start IP address</code>, the <code>end IP address</code>, and the subnet mask of the DHCP range (we suggest <code>192.168.122.1</code>, <code>192.168.122.254</code>, and <code>255.255.255.0</code>), in the <code>Add Exclusion and Delay</code> window exclude an IP address range to be used by attackers (we suggest <code>192.168.122.15 to 192.168.122.20</code>), in the <code>Configure DHCP Options</code> window select <code>Yes, I want to configure these options now</code>, in the <code>Router (Default Gateway)</code> window configure the IP address of the default gateway (<code>192.168.122.1</code>), in the <code>Domain Name and DNS Servers</code> window configure the parent domain as <code>polaris.local</code>, and the IP addresses of the DNS servers as <code>192.168.122.10</code> and <code>8.8.8.8</code>. Finally, in the <code>Activate Scope</code> window select <code>Yes, I want to activate this scope now</code>, click <code>Next \u2192 Finish</code>. At this point the corresponding Scope folder is added to the IPv4 section.</li> </ol>"},{"location":"labs/dc-configuration/#disable-smb-signing","title":"Disable SMB signing","text":"<p>(Only required for the SMB relay attack)</p> <p>To disable the SMB signing you will have to change the Registry. In the <code>Server Manager</code>, click on <code>Tools \u2192 Registry Editor</code> and set to <code>0</code> the following attributes:</p> <ul> <li><code>RequireSecuritySignature of HKEY_LOCAL_MACHINE\\System\\CurrentControlSet\\Services\\LanManWorkstation\\Parameters</code></li> <li><code>EnableSecuritySignature of HKEY_LOCAL_MACHINE\\System\\CurrentControlSet\\Services\\LanManWorkstation\\Parameters</code></li> <li><code>RequireSecuritySignature of HKEY_LOCAL_MACHINE\\System\\CurrentControlSet\\Services\\LanManServer\\Parameters</code></li> <li><code>EnableSecuritySignature of HKEY_LOCAL_MACHINE\\System\\CurrentControlSet\\Services\\LanManServer\\Parameters</code></li> </ul>"},{"location":"labs/inter-domain-attacks/trust-enumeration/","title":"Trust enumeration","text":""},{"location":"labs/intra-domain-attacks/lab-setup/","title":"Lab setup","text":"<p>The lab experiments will be performed using GNS3. The network scenario for the experiments is shown in Figure 1. DC1 and DM1 are both Windows Server 2022 appliances; the attacker is an Ubuntu Cloud Guest 22.04 appliance; the attacker_console is a Toolbox appliance.</p> <p></p>"},{"location":"labs/intra-domain-attacks/password-spraying/","title":"Password spraying","text":"<p>Once you know a few usernames, you can start guessing their passwords. The file valid_users.txt, available in the course materials folder, lists the valid users found in the previous exercise. While performing a Wireshark capture, run the following command to check if any valid user has the password Password123. ./kerbrute passwordspray -d polaris.local valid_users.txt --dc 192.168.122.10 Password123 Summary of what is to be explained: 1.  Explain the process of password spraying performed by kerbrute, using a Wireshark capture.</p>"},{"location":"labs/intra-domain-attacks/user-enumeration/","title":"User enumeration","text":"<p>This exercise resorts to kerbrute and a list of popular usernames, to obtain the usernames configured at the DC (valid usernames). Use the users.txt file stored in the course materials folder as the list of popular usernames. Run the following command while performing a Wireshark capture at the attacker\u2019s interface: <pre><code>./kerbrute userenum -d polaris.local users.txt --dc 192.168.122.10\n</code></pre> You may use a kerberos filter to analyze the Wireshark capture.</p> <p>Question</p> <p>Explain the user enumeration process, using a Wireshark capture.</p> Answer <p>The attacker sent nine AS-REQ messages over UDP, since there are nine usernames in the users.txt file. Received five PRINCIPAL UNKNOWN error messages, three PREAUTH REQUIRED, and one RESPONSE_TOO_BIG. The latter is due to user angela.moss with does not require pre-authentication. In this case, a TCP connection is established with the AD, the AS-REQ is sent again, and an AS-REP is received. The AS-REP message carries the username of the requesting user. The correlation between requests and responses in the UDP messages is done through the port number. </p> <p>Question</p> <p>How does kerbrute correlate the requests with the responses?</p> <p>Question</p> <p>What is the behavior in case of users not requiring pre-authentication?</p>"}]}